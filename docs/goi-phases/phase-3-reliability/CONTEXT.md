# Phase 3: 上下文与可靠性 - 上下文文档

## 阶段目标

构建上下文管理和失败恢复机制，确保长时间任务的可靠执行。

**核心理念**：上下文是稀缺资源，需要精心管理；任何失败都应该可恢复。

## 前置依赖

- Phase 0: 快照机制
- Phase 1: Agent Loop
- Phase 2: 检查点系统

## 技术背景

### 1. 上下文分层模型

```
┌─────────────────────────────────────────────────────────────────┐
│ 第1层：系统常量（始终存在，约2K tokens）                          │
│ • 平台能力说明（支持哪些操作）                                    │
│ • GOI接口定义                                                   │
│ • 行为准则（安全规范、确认规则）                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 第2层：会话上下文（可压缩，约5-20K tokens）                       │
│ • 用户原始目标                                                   │
│ • TODO List 当前状态                                            │
│ • 已完成操作的摘要                                               │
│ • 关键决策记录                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 第3层：工作上下文（高度动态，约3-10K tokens）                     │
│ • 当前TODO项的详细信息                                           │
│ • 最近几次操作的结果                                             │
│ • 当前页面/弹窗状态                                              │
│ • 临时查询结果                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 第4层：即时上下文（每次请求临时注入，约1-5K tokens）               │
│ • 当前步骤的系统提醒                                             │
│ • 检查点信息（如果有）                                           │
│ • 错误信息（如果有）                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 压缩策略

| 条件 | 触发动作 | 压缩级别 |
|------|---------|---------|
| 上下文 > 70% | 显示预警，建议用户手动压缩 | - |
| 上下文 > 85% | 自动触发压缩 | 标准压缩 |
| 上下文 > 90% | 立即压缩 | 深度压缩 |
| 完成一个阶段 | 可选压缩 | 阶段压缩 |
| 检查点通过后 | 可选压缩 | 检查点压缩 |

#### 压缩级别说明

**标准压缩（保留率约60%）**：
- 保留：目标、TODO List、所有决策点、最近3个操作详情
- 压缩：早期操作详情改为摘要
- 丢弃：中间查询结果、重复信息

**深度压缩（保留率约30%）**：
- 保留：目标、TODO List状态、关键决策
- 压缩：所有操作改为一句话摘要
- 丢弃：操作详情、查询结果

**阶段压缩（完成一个阶段后）**：
- 保留：阶段完成状态、产出物ID
- 压缩：整个阶段的操作合并为一段摘要
- 丢弃：阶段内的中间状态

### 3. 失败分类与处理

| 失败类型 | 说明 | 处理策略 |
|---------|------|---------|
| 临时性失败 | 网络超时、服务暂时不可用 | 自动重试（最多3次） |
| 数据性失败 | 资源不存在、数据校验不通过 | 回滚并报告用户 |
| 逻辑性失败 | 操作前置条件不满足 | 尝试重规划 |
| 权限性失败 | 无权限执行某操作 | 回滚并报告用户 |
| 系统性失败 | 服务崩溃、数据库异常 | 回滚并告警 |

### 4. 回滚流程

```
检测到失败
    │
    ▼
┌─────────────────────────────────────┐
│ 1. 立即停止后续TODO项执行             │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 2. 确定回滚目标快照                  │
│    - 默认：当前TODO项开始前的快照     │
│    - 如果不可用：上一个检查点快照      │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 3. 执行状态回滚                      │
│    - 撤销已创建的资源                │
│    - 恢复已修改的资源                │
│    - 恢复已删除的资源（软删除）       │
│    - 恢复UI状态                      │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 4. 更新TODO List状态                 │
│    - 标记失败项                      │
│    - 更新进度                        │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 5. 生成失败报告                      │
│    - 失败原因分析                    │
│    - 已回滚的操作                    │
│    - 建议的下一步                    │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 6. 通知用户                          │
│    - 在Copilot面板显示失败信息       │
│    - 提供选项：重试/跳过/重规划/放弃  │
└─────────────────────────────────────┘
```

## 涉及的文件/模块

### 新增文件

```
packages/shared/types/goi/
├── context.ts          # 上下文类型定义
└── failure.ts          # 失败处理类型

apps/web/src/lib/goi/
├── context/
│   ├── manager.ts      # 上下文管理器
│   ├── compressor.ts   # 压缩逻辑
│   ├── tokenCounter.ts # Token 计数
│   └── templates.ts    # 压缩摘要模板
├── failure/
│   ├── classifier.ts   # 失败分类器
│   ├── rollback.ts     # 回滚执行器
│   ├── reporter.ts     # 失败报告生成
│   └── retryStrategy.ts # 重试策略

apps/web/src/components/goi/
├── ContextWarning.tsx  # 上下文警告组件
├── CompressDialog.tsx  # 压缩确认弹窗
└── FailureRecovery.tsx # 失败恢复界面

apps/web/src/app/api/goi/
├── context/route.ts    # 上下文管理 API
└── failure/route.ts    # 失败处理 API
```

## 压缩摘要模板

```
┌─────────────────────────────────────────────────────────────────┐
│                      上下文压缩摘要                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 【会话目标】                                                     │
│ 用户要创建一个测试任务，使用 sentiment-v2 提示词和 test-data 数据集│
│                                                                 │
│ 【已完成工作】                                                   │
│ ✅ 阶段1-资源定位（5项）: 已选择 sentiment-v2 提示词              │
│ ✅ 阶段2-数据集配置（4项）: 已选择 test-data 数据集，100条数据    │
│ ⏳ 阶段3-字段映射: 进行中                                        │
│                                                                 │
│ 【当前状态】                                                     │
│ • 页面: /tasks/new                                              │
│ • 已选资源:                                                     │
│   - promptId: "prompt-uuid-123"                                 │
│   - datasetId: "dataset-uuid-456"                               │
│ • 待配置: 字段映射、评估器                                       │
│                                                                 │
│ 【关键决策】                                                     │
│ • 用户确认选择 sentiment-v2（而非 sentiment-v1）                 │
│ • 数据集映射方式选择"自动推断"                                   │
│                                                                 │
│ 【下一步】                                                       │
│ 继续执行 TODO #3.3: 配置输入字段映射                             │
│                                                                 │
│ 【约束条件】                                                     │
│ • 用户要求使用精确匹配评估器                                     │
│ • 不需要配置LLM评估                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 失败报告模板

```
┌─────────────────────────────────────────────────────────────────┐
│ ⚠️ 任务执行失败                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 📍 失败位置                                                      │
│    TODO项: "选中数据集"                                          │
│    阶段: 数据集配置 (第3项，共12项)                               │
│                                                                 │
│ ❌ 失败原因                                                      │
│    搜索 "test-data" 未找到匹配的数据集                           │
│    可能的原因：                                                  │
│    • 数据集名称拼写错误                                          │
│    • 数据集已被删除                                              │
│    • 当前用户无权限访问该数据集                                   │
│                                                                 │
│ 🔄 已执行的回滚                                                  │
│    • 关闭了数据集选择器                                          │
│    • 清除了搜索条件                                              │
│    • 状态已恢复到"选择提示词"完成后                               │
│                                                                 │
│ 💡 建议操作                                                      │
│    ┌────────────────────────────────────────────────────────┐  │
│    │ [重新搜索] 尝试其他关键词搜索数据集                      │  │
│    │ [手动选择] 我来手动选择数据集                            │  │
│    │ [跳过此步] 暂时跳过，稍后配置                            │  │
│    │ [放弃任务] 取消本次任务创建                              │  │
│    └────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 验收标准

### 功能验收

- [ ] 上下文使用量可准确监控
- [ ] 压缩可自动触发，不丢失关键信息
- [ ] 失败可正确分类
- [ ] 回滚可恢复到安全状态
- [ ] 用户收到清晰的失败报告和选项

### 性能验收

- [ ] Token 计数准确率 > 95%
- [ ] 标准压缩后可继续执行任务成功率 > 90%
- [ ] 回滚成功率 > 95%

## 注意事项

1. **压缩时机**：在模型调用间隙压缩，不阻塞用户交互
2. **关键信息标记**：允许 TODO 项标记为"不可压缩"
3. **软删除**：删除操作使用软删除，支持恢复
4. **回滚日志**：所有回滚操作记录到事件流

## 参考资源

- Claude Token 计数：使用 tiktoken 或 Anthropic SDK
- 压缩 Prompt：参考 Claude 最佳实践
