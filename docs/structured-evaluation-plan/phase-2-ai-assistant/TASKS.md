# Phase 2: AI 配置助手 + 高级评估 - 任务清单

> 预计工期：3-4 周（25 工作日）
> 后端：13d | 前端：12d
> 前置依赖：Phase 1 完成

## 任务总览

| 周次 | 主要任务 | 交付物 |
|------|---------|--------|
| Week 5-6 | AI 配置助手 | 对话式 Schema 生成 |
| Week 7 | 高级评估能力 | 条件评估、聚合策略、字段 API |
| Week 8 | 结果展示升级 | 详情页、统计页、任务流程 |

---

## Week 5-6: AI 配置助手（核心功能）

### 5.1 AI Schema 生成 API（3d）

- [ ] **5.1.1** 创建生成服务
  - `apps/web/src/services/aiSchemaGenerator.ts`

- [ ] **5.1.2** 实现 AI 调用逻辑
  - 使用用户选择的模型
  - 构建 System Prompt
  - 解析 AI 返回的 JSON

- [ ] **5.1.3** 实现 Schema 组装
  - `packages/shared/src/schema/schemaAssembler.ts`
  - `assembleSchemas(aiOutput, sceneName)` 函数
  - 中文转拼音（key 生成）
  - 数据集字段名生成（ctx_/exp_ 前缀）
  - 评估器推断
  - 权重均分
  - 聚合策略推断

- [ ] **5.1.4** 创建 API 路由
  - `POST /api/v1/schemas/ai-generate`
  - 参数校验
  - 返回 AI 原始输出 + 组装后的 Schema

- [ ] **5.1.5** 实现模板列生成
  - 根据组装后的 Schema 生成 `templateColumns`
  - 包含输入列和期望值列

### 5.2 生成 Prompt 设计（1d）

- [ ] **5.2.1** 设计 System Prompt
  - 精简输出格式
  - 明确字段说明
  - 提供示例

- [ ] **5.2.2** 测试 Prompt 效果
  - 多场景测试
  - 调整优化

### 5.3 模型选择器组件（1d）

- [ ] **5.3.1** 创建/复用组件
  - 下拉选择已配置的模型
  - 显示模型提供商和名称
  - 推荐能力较强的模型

### 5.4 AI 助手对话界面（3d）

- [ ] **5.4.1** 创建页面
  - `apps/web/src/app/(dashboard)/schemas/ai-assistant/page.tsx`

- [ ] **5.4.2** 实现 Step 1: 选择模型
  - 模型下拉选择器
  - 已配置模型列表展示
  - 使用提示

- [ ] **5.4.3** 实现 Step 2: 描述场景
  - 场景名称输入
  - 多行文本描述区域
  - 引导提示（输入/输出/关键字段）
  - "生成配置"按钮
  - 加载状态

- [ ] **5.4.4** 实现 Step 3: 确认结构
  - InputSchema 预览表格
  - OutputSchema 预览表格
  - 字段可编辑（Phase 3 优化）
  - 重新生成按钮
  - 确认并继续按钮

- [ ] **5.4.5** 实现 Step 4: 下载模板
  - 保存 Schema 到数据库
  - 显示模板列预览
  - Excel/CSV 下载按钮
  - 后续操作引导链接

### 5.5 结构预览与编辑（2d）

- [ ] **5.5.1** 创建预览组件
  - `apps/web/src/components/schema/SchemaPreview.tsx`
  - 表格展示变量/字段
  - 类型、必填、关键字段标识

- [ ] **5.5.2** 实现简单编辑
  - 修改名称
  - 修改类型
  - 切换必填/关键字段

### 5.6 一键模板下载（1d）

- [ ] **5.6.1** 集成模板生成
  - 调用 Phase 1 的模板生成 API
  - 支持 Excel/CSV 格式

- [ ] **5.6.2** 优化下载体验
  - 显示列定义预览
  - 下载后提示

---

## Week 7: 高级评估能力

### 7.1 条件表达式求值器（2d）

- [ ] **7.1.1** 创建求值器模块
  - `packages/shared/src/evaluator/conditionEvaluator.ts`

- [ ] **7.1.2** 实现安全求值
  - 表达式白名单检查
  - 禁止危险关键字
  - 沙箱执行（Function 构造器）

- [ ] **7.1.3** 实现 `evaluate()` 方法
  - 解析表达式
  - 执行求值
  - 返回 boolean

- [ ] **7.1.4** 集成到字段评估引擎
  - 评估前检查条件
  - 条件不满足时标记为跳过

- [ ] **7.1.5** 单元测试
  - 各种表达式
  - 安全检查
  - 边界情况

### 7.2 关键字段聚合策略（1d）

- [ ] **7.2.1** 实现 `critical_first` 模式
  - 分离关键/普通字段
  - 先检查关键字段
  - 关键字段失败直接返回失败
  - 关键字段通过后计算普通字段加权

- [ ] **7.2.2** 单元测试
  - 关键字段全过场景
  - 关键字段失败场景
  - 无普通字段场景

### 7.3 自定义聚合表达式（2d）

- [ ] **7.3.1** 实现 `custom` 模式
  - 构建字段结果映射
  - 沙箱执行表达式
  - 返回聚合结果

- [ ] **7.3.2** 表达式校验
  - 语法检查
  - 引用字段检查

- [ ] **7.3.3** 单元测试
  - 各种表达式
  - 错误处理

### 7.4 FieldEvaluationResult API（2d）

- [ ] **7.4.1** 扩展结果详情 API
  - `GET /api/v1/tasks/:id/results/:resultId`
  - 返回 `fieldEvaluations` 数组
  - 返回 `aggregation` 对象

- [ ] **7.4.2** 创建字段结果列表 API
  - `GET /api/v1/tasks/:id/results/:resultId/fields`
  - 支持分页

### 7.5 字段级统计 API（2d）

- [ ] **7.5.1** 创建统计服务
  - `apps/web/src/services/fieldStatistics.ts`

- [ ] **7.5.2** 实现统计计算
  - 按字段分组
  - 计算通过率、平均分
  - 统计通过/失败/跳过数量

- [ ] **7.5.3** 实现失败原因聚合
  - 按字段分组失败原因
  - 统计原因出现次数

- [ ] **7.5.4** 创建 API 路由
  - `GET /api/v1/tasks/:id/stats/fields`
  - 返回字段统计和失败原因

---

## Week 8: 结果展示升级

### 8.1 结果详情页升级（3d）

- [ ] **8.1.1** 扩展结果详情页
  - `apps/web/src/app/(dashboard)/tasks/[id]/results/[resultId]/page.tsx`

- [ ] **8.1.2** 实现字段评估表格
  - 显示字段名、实际值、期望值
  - 显示评估器、通过状态、得分
  - 关键字段标识（★）
  - 跳过字段灰显

- [ ] **8.1.3** 实现聚合计算明细
  - 聚合模式显示
  - 关键字段检查结果
  - 普通字段权重明细表
  - 最终得分计算公式

- [ ] **8.1.4** 优化输入/输出展示
  - 结构化输入上下文展示
  - 解析后的字段展示
  - 原始输出折叠

### 8.2 字段级统计页面（3d）

- [ ] **8.2.1** 新增"字段分析" Tab
  - 任务统计页新增 Tab

- [ ] **8.2.2** 实现字段通过率图表
  - 柱状图展示各字段通过率
  - 关键字段标识

- [ ] **8.2.3** 实现字段详细统计表
  - 字段名、通过率、平均分
  - 通过数、失败数、跳过数
  - 主要失败原因

- [ ] **8.2.4** 实现字段得分分布图
  - 每个字段的得分分布直方图

### 8.3 条件配置 UI（1d）

- [ ] **8.3.1** 扩展 OutputSchema 编辑器
  - 字段评估配置中添加条件输入框
  - 条件表达式提示
  - 语法校验提示

### 8.4 自定义聚合 UI（1d）

- [ ] **8.4.1** 扩展聚合配置
  - 添加 `custom` 模式选项
  - 自定义表达式输入框
  - 表达式说明和示例

### 8.5 任务创建流程改造（2d）

- [ ] **8.5.1** 改造提示词选择步骤
  - 显示关联的 Schema 信息
  - 显示输入/输出结构预览
  - 显示聚合策略

- [ ] **8.5.2** 改造数据集选择步骤
  - 字段映射校验
  - 显示映射状态
  - 未映射字段警告

- [ ] **8.5.3** 兼容性提示
  - Schema 与数据集不兼容时提示
  - 引导用户调整

### 8.6 集成测试（2d）

- [ ] **8.6.1** AI 配置助手测试
  - 生成 → 预览 → 保存 → 下载

- [ ] **8.6.2** 条件评估测试
  - 条件满足/不满足场景

- [ ] **8.6.3** 聚合策略测试
  - critical_first 各场景
  - custom 表达式各场景

- [ ] **8.6.4** 结果展示测试
  - 字段级详情正确显示
  - 统计数据准确

---

## 验收标准

### 功能验收

- [ ] AI 配置助手可正常生成 Schema
- [ ] 生成的 Schema 结构正确、可用
- [ ] 可选择任意已配置模型进行生成
- [ ] 生成后可直接下载数据集模板
- [ ] 条件表达式正确求值
- [ ] 条件不满足时字段被跳过
- [ ] critical_first 聚合正确
- [ ] custom 聚合表达式正确执行
- [ ] 结果详情展示字段级评估
- [ ] 聚合计算明细展示正确
- [ ] 字段级统计数据准确
- [ ] 任务创建流程适配完整

### 质量验收

- [ ] AI 生成成功率 > 90%
- [ ] 条件表达式安全（无注入风险）
- [ ] 统计查询性能 < 2s
- [ ] 单元测试覆盖核心逻辑

---

## 开发日志

### Week 5

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| 2024-12-10 | 5.1.3 Schema 组装器 (schemaAssembler.ts) | 实现中文关键词映射转 key |
| 2024-12-10 | 5.1.1-5.1.4 AI 生成服务 + API 路由 | aiSchemaGenerator.ts + POST /api/v1/schemas/ai-generate |
| 2024-12-10 | 5.4.1-5.4.5 AI 助手对话界面 | 4 步骤式向导页面完成 |

### Week 6

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| | | |

### Week 7

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| 2024-12-10 | 7.1 条件表达式求值器 | conditionEvaluator.ts + 18 个单元测试 |
| 2024-12-10 | 7.2-7.3 聚合策略升级 | critical_first 已有，新增 custom 自定义表达式模式 |
| 2024-12-10 | 7.4 字段级结果 API | GET /api/v1/tasks/:id/results/:resultId |
| 2024-12-10 | 7.5 字段级统计 API | GET /api/v1/tasks/:id/stats/fields |

### Week 8

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| 2024-12-10 | 8.1 结果详情页升级 | ResultDetailV2 组件，支持字段级评估展示 |
| 2024-12-10 | 8.2 字段分析页面 | FieldAnalysisPanel 组件，统计图表和失败原因分析 |
