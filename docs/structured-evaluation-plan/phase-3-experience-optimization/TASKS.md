# Phase 3: 体验优化 + 生态完善 - 任务清单

> 预计工期：2-3 周（13 工作日）
> 后端：9d | 前端：4d
> 前置依赖：Phase 1、Phase 2 完成

## 任务总览

| 周次 | 主要任务 | 交付物 |
|------|---------|--------|
| Week 9 | 易用性优化 | 模板库、推断、快速测试、多轮对话 |
| Week 10 | 导出与报告 | 字段级导出、回归检测、监控告警 |

---

## Week 9: 易用性优化

### 9.1 Schema 模板库（2d）

- [x] **9.1.1** 设计模板数据结构
  - 模板 ID、名称、分类、描述
  - 完整的 InputSchema
  - 完整的 OutputSchema

- [x] **9.1.2** 创建预置模板
  - 智能客服意图识别
  - 文档摘要生成
  - 情感分析
  - 代码审查
  - 实体抽取

- [x] **9.1.3** 实现模板 API
  - `GET /api/v1/schemas/templates` - 列表
  - `GET /api/v1/schemas/templates/:id` - 详情
  - `POST /api/v1/schemas/templates/:id/use` - 使用模板

- [x] **9.1.4** 实现模板库页面
  - 分类展示
  - 模板卡片
  - 一键使用

### 9.2 Schema 从输出推断（2d）

- [x] **9.2.1** 创建推断服务
  - `apps/web/src/services/schemaInfer.ts`

- [x] **9.2.2** 实现推断逻辑
  - 解析 JSON 输出
  - 递归分析字段类型
  - 生成字段定义

- [x] **9.2.3** 创建 API 路由
  - `POST /api/v1/schemas/infer-from-output`
  - 参数校验（有效 JSON）
  - 返回推断的字段列表

- [x] **9.2.4** 创建推断弹窗组件
  - `apps/web/src/components/schema/InferSchemaModal.tsx`
  - 样本输入区域
  - 推断按钮
  - 结果预览和编辑
  - 创建 Schema 按钮

### 9.3 快速测试（结构化）（2d）

- [x] **9.3.1** 改造快速测试弹窗
  - `apps/web/src/components/prompt/QuickTest.tsx`

- [x] **9.3.2** 实现动态输入表单
  - 根据 InputSchema 生成表单
  - 支持各种类型输入控件
  - 数组类型支持动态添加/删除

- [x] **9.3.3** 实现结构化输出展示
  - 显示解析后的字段值
  - 字段名 + 值表格
  - 原始输出折叠区域

- [x] **9.3.4** 扩展快速测试 API
  - 支持结构化 variables 参数
  - 返回 parsed、parseSuccess、outputFields 字段

### 9.4 AI 助手多轮对话（2d）

- [x] **9.4.1** 设计对话状态管理
  - 保存当前 Schema 状态
  - 保存对话历史

- [x] **9.4.2** 实现追问处理
  - 解析用户意图（添加字段、修改配置、删除字段）
  - 调用 AI 生成更新指令
  - 应用更新到当前 Schema

- [x] **9.4.3** 改造 AI 助手界面
  - 添加对话历史展示
  - 支持追问输入
  - 实时更新 Schema 预览

---

## Week 10: 导出与报告

### 10.1 结果导出增强（2d）

- [x] **10.1.1** 扩展导出服务
  - `apps/web/src/lib/exporter.ts`

- [x] **10.1.2** 实现字段级评估 Sheet
  - 行号、字段名、实际值、期望值
  - 评估器、通过、得分、原因

- [x] **10.1.3** 实现聚合详情 Sheet
  - 行号、聚合模式
  - 关键字段通过情况
  - 加权得分、最终结果

- [x] **10.1.4** 扩展导出 API
  - 添加 `includeFieldEvaluations` 参数
  - 支持多 Sheet Excel 导出

### 10.2 字段级回归检测（3d）

- [x] **10.2.1** 创建回归检测服务
  - 集成在 `/api/v1/tasks/compare` 路由中

- [x] **10.2.2** 实现对比逻辑
  - 获取两个任务的字段统计
  - 按字段对比通过率
  - 计算变化值和方向

- [x] **10.2.3** 实现回归判断
  - 根据阈值判断是否回归
  - 区分关键字段和普通字段阈值

- [x] **10.2.4** 创建对比 API
  - `POST /api/v1/tasks/compare`
  - 返回总体对比和字段级对比

- [x] **10.2.5** 创建对比页面
  - `apps/web/src/app/(dashboard)/tasks/compare/page.tsx`
  - 选择两个任务
  - 展示对比结果
  - 高亮回归字段

### 10.3 监控告警扩展（2d）

- [x] **10.3.1** 扩展告警规则类型
  - `FIELD_PASS_RATE` - 字段通过率
  - `FIELD_AVG_SCORE` - 字段平均分
  - `FIELD_REGRESSION` - 字段回归
  - 添加 `FieldAlertConfig` 类型

- [x] **10.3.2** 实现字段级监控逻辑
  - 任务完成后检查字段指标
  - 触发告警规则

- [x] **10.3.3** 扩展告警规则 UI
  - 支持选择字段
  - 支持配置字段级阈值

### 10.4 文档与上线（2d）

- [x] **10.4.1** 更新用户文档
  - 结构化评估完整指南
  - AI 配置助手使用说明
  - 字段级分析说明

- [x] **10.4.2** 更新 API 文档
  - 所有新增 API
  - 扩展参数说明

- [ ] **10.4.3** 上线检查清单
  - 功能完整性检查
  - 性能测试
  - 兼容性验证

- [ ] **10.4.4** 部署上线
  - 数据库迁移
  - 服务部署
  - 监控配置

---

## 验收标准

### 功能验收

- [ ] 模板库包含 5+ 常用场景模板
- [ ] 模板可一键使用创建 Schema
- [ ] 从输出推断 Schema 准确
- [ ] 推断结果可编辑调整
- [ ] 快速测试支持结构化输入
- [ ] 快速测试展示解析后字段
- [ ] AI 助手支持多轮对话
- [ ] 导出包含字段级评估 Sheet
- [ ] 导出包含聚合详情 Sheet
- [ ] 回归检测能识别字段级变化
- [ ] 监控支持字段级告警规则

### 质量验收

- [ ] 所有功能通过测试
- [ ] 文档完整更新
- [ ] 无阻塞性 bug
- [ ] 性能符合预期

---

## 开发日志

### Week 9

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| 2025-12-11 | 9.1.1-9.1.4 Schema 模板库 | 5 个预置模板 + 完整 API + 模板库页面 |
| 2025-12-11 | 9.2.1-9.2.4 Schema 从输出推断 | 推断服务 + API + 弹窗组件 |
| 2025-12-11 | 9.3.1-9.3.4 快速测试结构化输出 | API 返回 parsed/outputFields，UI 展示字段表格 |
| 2025-12-11 | 9.4.1-9.4.3 AI 助手多轮对话 | 追问 API + 对话历史 + 增量更新 Schema |

### Week 10

| 日期 | 完成任务 | 问题/备注 |
|------|---------|----------|
| 2025-12-11 | 10.1.1-10.1.4 结果导出增强 | 聚合详情 Sheet + includeAggregation 参数 + 多 Sheet 导出 |
| 2025-12-11 | 10.2.1-10.2.5 字段级回归检测 | /api/v1/tasks/compare API + 对比页面 |
| 2025-12-11 | 10.3.1-10.3.3 监控告警扩展 | 字段级指标类型 + 监控逻辑 + AlertRuleModal UI |
| 2025-12-11 | 10.4.1-10.4.2 文档更新 | 更新 API 文档 + 评估器文档添加结构化评估指南 |

---

## 里程碑确认

**Phase 3 完成标志**：

- [ ] 所有任务完成
- [ ] 验收标准全部通过
- [ ] 文档更新完成
- [ ] 成功部署上线
- [ ] 用户可正常使用全部功能

---

## 项目总结

完成 Phase 3 后，结构化评估能力升级项目全部完成：

| Phase | 内容 | 状态 |
|-------|------|------|
| Phase 1 | 基础结构化能力 | ✅ 已完成 |
| Phase 2 | AI 配置助手 + 高级评估 | ✅ 已完成 |
| Phase 3 | 体验优化 + 生态完善 | ✅ 代码完成 |

**总计**：约 10 周（73 工作日）

**核心交付物**：
1. 结构化输入/输出定义（Schema）
2. 字段级评估引擎
3. 多种聚合策略
4. AI 配置助手
5. 字段级统计分析
6. 回归检测能力
7. 完整的用户文档

**待上线**: 10.4.3 上线检查清单、10.4.4 部署上线
