# 结构化评估能力升级计划

> 基于 `docs/12-structured-evaluation-upgrade-plan-v2.md` 拆解的分阶段实施计划

## 项目概述

本计划将平台从**简单三元组模型**升级为**结构化评估引擎**，支持：
- 任意数量、任意结构的输入变量定义
- 任意数量、任意结构的输出字段定义
- 每个输出字段独立配置评估器、期望值来源、权重
- 字段间条件依赖评估
- 多种聚合策略（全部通过、加权平均、关键字段）

## 核心问题

当前平台基于简单三元组：
```
input(string) → LLM → output(string) → 对比 expected(string) → passed/failed
```

面对复杂 AI 应用评估时完全失效：
- 动态数量的输入上下文变量
- 结构化多字段输出
- 每字段独立评估逻辑
- 字段间有依赖关系
- 字段重要性不同

## 分阶段实施计划

### Phase 1: 基础结构化能力（4-5 周）✅ 已完成

**目标**：支持结构化输出定义、解析、字段级评估、数据集基础改造

| 模块 | 内容 |
|------|------|
| 后端核心 | 数据模型、Schema API、解析器、评估引擎、聚合引擎 |
| 数据集改造 | 模板生成、上传流程、字段映射、数据校验 |
| 任务执行 | 执行器升级、结果存储扩展 |
| 前端基础 | Schema 管理页、编辑器、提示词关联 |

**交付物**：
- ✅ 可创建/编辑输入输出结构定义
- ✅ 提示词可关联结构定义
- ✅ 数据集模板下载（根据 Schema 生成）
- ✅ 数据集上传支持字段映射
- ✅ 任务执行支持结构化输出解析和字段级评估
- ✅ 基础聚合（全部通过、加权平均）

---

### Phase 2: AI 配置助手 + 高级评估（3-4 周）✅ 已完成

**目标**：AI 智能配置、条件评估、关键字段、完整结果展示

| 模块 | 内容 |
|------|------|
| AI 配置助手 | 模型选择、场景描述、Schema 生成、模板下载 |
| 高级评估 | 条件表达式、关键字段聚合、自定义聚合 |
| 结果展示 | 字段级评估详情、字段级统计、任务流程改造 |

**交付物**：
- ✅ **AI 配置助手**（选择模型 → 描述场景 → 生成 Schema → 下载模板）
- ✅ 字段间条件依赖评估
- ✅ 关键字段优先聚合
- ✅ 字段级评估结果查看
- ✅ 字段级统计分析
- ✅ 任务创建流程适配

---

### Phase 3: 体验优化 + 生态完善（2-3 周）✅ 代码完成

**目标**：提升易用性、完善周边功能

| 模块 | 内容 |
|------|------|
| 易用性优化 | Schema 模板库、从输出推断、快速测试、多轮对话 |
| 导出与报告 | 字段级导出、回归检测、监控告警扩展 |

**交付物**：
- ✅ 常用 Schema 模板
- ✅ 从样本输出自动推断 Schema
- ✅ 快速测试支持结构化
- ✅ 字段级导出报告
- ✅ 字段级回归检测
- ⬜ 上线检查清单、部署上线

---

## 时间线

```
Phase 1: 基础结构化能力 (Week 1-5)
├── Week 1: 数据模型 + Schema API
├── Week 2: 解析器 + 评估引擎 + 数据集模板API
├── Week 3: 任务执行器 + 数据集上传改造
├── Week 4: Schema UI + 数据集映射向导
└── Week 5: 提示词关联 + 集成测试
    │
    ▼ 里程碑 1: 基础结构化评估可用

Phase 2: AI配置助手 + 高级评估 (Week 5-8)
├── Week 5-6: AI 配置助手
├── Week 7: 条件评估 + 聚合策略 + 字段API
└── Week 8: 结果详情 + 统计页面 + 任务流程改造
    │
    ▼ 里程碑 2: AI 辅助配置上线，高级评估完整

Phase 3: 体验优化 (Week 9-10)
├── Week 9: 模板库 + 推断 + 快速测试
└── Week 10: 导出增强 + 回归检测 + 上线
    │
    ▼ 里程碑 3: 全功能上线
```

## 工作量统计

| Phase | 后端 | 前端 | 总计 |
|-------|------|------|------|
| Phase 1 | 22d | 13d | 35d (约5周) |
| Phase 2 | 13d | 12d | 25d (约4周) |
| Phase 3 | 9d | 4d | 13d (约2周) |
| **总计** | **44d** | **29d** | **73d (约10周)** |

## 关键依赖关系

```
数据模型 ──► Schema API ──► Schema UI
    │              │            │
    │              ▼            ▼
    │        模板生成API ──► 模板下载弹窗
    │              │
    ▼              ▼
解析器 ──► 任务执行器 ──► 结果存储
    │              │
    ▼              ▼
评估引擎 ──────────┘
    │
    ▼
聚合引擎 ──► 结果详情页 ──► 统计页面
                               │
AI生成API ──► AI助手UI ──────────┘
```

## 文件结构

```
docs/structured-evaluation-plan/
├── README.md                           # 本文件 - 计划总览
├── phase-1-basic-structured/           # Phase 1: 基础结构化能力
│   ├── CONTEXT.md                      # 上下文信息
│   └── TASKS.md                        # 任务清单
├── phase-2-ai-assistant/               # Phase 2: AI 配置助手 + 高级评估
│   ├── CONTEXT.md
│   └── TASKS.md
└── phase-3-experience-optimization/    # Phase 3: 体验优化 + 生态完善
    ├── CONTEXT.md
    └── TASKS.md
```

## 使用方式

1. 按阶段顺序开发，每个阶段有明确的前置依赖
2. 开发前阅读该阶段的 `CONTEXT.md` 了解上下文
3. 按照 `TASKS.md` 中的任务清单逐项完成
4. 在 `TASKS.md` 底部的开发日志中记录进度

## 参考文档

- 详细技术方案：`docs/12-structured-evaluation-upgrade-plan-v2.md`
- 数据库设计：`docs/04-database-schema.md`
- API 规范：`docs/03-api-spec.md`
- 评估器规范：`docs/05-evaluator-spec.md`
