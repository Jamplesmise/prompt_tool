# AI测试平台 GOI 改造开发计划

> 版本：v1.0  
> 日期：2024-12  
> 状态：技术方案  
> 核心理念：让AI能操控全局，同时人类保持完全控制权

---

## 一、设计哲学

### 1.1 从 Claude Code 学到的核心思想

#### 思想一：策略与机制分离 (Policy-Mechanism Separation)

**传统GUI的问题**：用户想要完成一个目标（策略），必须自己执行一系列具体操作（机制）。对于LLM来说，这意味着需要生成冗长、易错的操作序列。

**GOI的解法**：让LLM只负责声明"想要什么"（策略），系统负责"如何实现"（机制）。

| 层面 | 传统模式 | GOI模式 |
|------|---------|---------|
| LLM职责 | 规划操作序列 + 执行导航 | 仅声明目标状态 |
| 系统职责 | 被动响应指令 | 主动解析并执行到达路径 |
| 错误处理 | LLM需要感知并修复 | 系统自动重试或回滚 |

#### 思想二：TODO List 驱动的可观测执行

Claude Code 的精髓不是"AI自动完成一切"，而是**让执行过程透明可控**：

- **可见性**：用户始终知道AI在做什么、打算做什么
- **可干预**：用户可以在任意节点暂停、修改、接管
- **可追溯**：每个操作都有记录，可以理解"为什么这样做"

#### 思想三：Gather-Act-Verify 循环

每个操作都遵循三阶段循环：

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│   │ Gather  │ ──► │   Act   │ ──► │ Verify  │ ──┐         │
│   │ 收集上下文│     │ 执行操作 │     │ 验证结果 │   │         │
│   └─────────┘     └─────────┘     └─────────┘   │         │
│        ▲                                         │         │
│        └─────────────────────────────────────────┘         │
│                    (下一个任务)                              │
└─────────────────────────────────────────────────────────────┘
```

#### 思想四：上下文是稀缺资源

LLM的上下文窗口有限，必须精心管理：

- **主动压缩**：在上下文达到85%时主动压缩，而非等到95%被动触发
- **分层存储**：关键决策放在上下文，执行细节放在外部存储
- **智能遗忘**：保留"完成了什么"和"接下来做什么"，丢弃"具体怎么做的"

### 1.2 核心设计原则

#### 原则一：无AI也能完整运行

```
┌─────────────────────────────────────────────────────────────┐
│                      系统架构分层                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              AI Copilot Layer (可选)                 │   │
│  │         GOI声明式接口 + Agent Loop                   │   │
│  └───────────────────────┬─────────────────────────────┘   │
│                          │ 调用                             │
│  ┌───────────────────────▼─────────────────────────────┐   │
│  │              Event Layer (必须)                      │   │
│  │         所有操作记录为事件流                          │   │
│  └───────────────────────┬─────────────────────────────┘   │
│                          │ 触发                             │
│  ┌───────────────────────▼─────────────────────────────┐   │
│  │              Core API Layer (必须)                   │   │
│  │         原有的增删查改API保持不变                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**关键决策**：GOI层是在现有API之上的**装饰层**，不改变底层API。

这意味着：
- 关闭AI功能后，系统完全按原有方式工作
- 人类操作和AI操作使用**同一套底层API**
- 事件层记录所有操作，无论来源是人还是AI

#### 原则二：细粒度操作追踪

将每个业务操作拆分到最小可观测单元：

| 业务操作 | 拆分后的原子操作 |
|---------|----------------|
| 选择数据集 | 1. 打开数据集选择器<br>2. 输入搜索条件<br>3. 浏览搜索结果<br>4. 选中目标数据集<br>5. 确认选择 |
| 配置评估器 | 1. 打开评估器配置面板<br>2. 选择评估器类型<br>3. 填写配置参数<br>4. 验证配置有效性<br>5. 保存配置 |
| 执行测试任务 | 1. 校验任务配置完整性<br>2. 创建任务记录<br>3. 启动执行引擎<br>4. 等待执行完成<br>5. 汇总执行结果 |

**为什么要这么细？**

1. **精确回滚**：失败时可以回退到具体哪一步
2. **断点续作**：用户接管后可以从任意步骤继续
3. **学习优化**：可以分析哪些步骤容易出错

#### 原则三：失败安全 (Fail-Safe)

当任何操作失败时：

```
失败发生
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 立即停止后续操作                       │
│ 2. 回滚到上一个稳定状态                   │
│ 3. 保存失败现场（用于诊断）               │
│ 4. 生成用户可理解的失败报告               │
│ 5. 等待用户决策（重试/跳过/放弃）         │
└─────────────────────────────────────────┘
```

---

## 二、核心概念定义

### 2.1 GOI 三原语

#### Access（访问声明）

声明要访问哪个资源，系统负责导航到该资源。

**适用场景**：
- 打开某个提示词的详情页
- 进入数据集管理模块
- 查看某个任务的执行结果

**关键特性**：
- 只声明目标，不关心当前在哪个页面
- 系统自动处理页面跳转、Tab切换、弹窗打开等

#### State（状态声明）

声明资源的期望状态，系统负责将资源变更到该状态。

**适用场景**：
- 创建一个新的提示词
- 更新数据集的字段映射
- 将任务状态设置为"执行中"

**关键特性**：
- 只描述最终状态，不描述变更过程
- 系统自动计算差异并应用变更
- 支持原子性（要么全成功，要么全回滚）

#### Observation（观察声明）

声明要获取哪些信息，系统负责收集并返回。

**适用场景**：
- 查询任务的执行进度
- 获取数据集的统计信息
- 检查评估器的配置是否有效

**关键特性**：
- 只读操作，不产生副作用
- 返回结构化数据，便于AI理解
- 可以批量查询多个信息点

### 2.2 TODO Item 结构

每个TODO项代表一个**原子操作**：

```
┌─────────────────────────────────────────────────────────────┐
│                        TODO Item                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  标识信息                                                    │
│  ├── id: 唯一标识                                           │
│  ├── title: 简短标题（用户可见）                             │
│  └── description: 详细描述（AI理解用）                       │
│                                                             │
│  执行信息                                                    │
│  ├── category: access | state | observation | verify        │
│  ├── goiOperation: 对应的GOI操作定义                         │
│  ├── dependsOn: 前置依赖项ID列表                            │
│  └── estimatedDuration: 预估耗时                            │
│                                                             │
│  状态信息                                                    │
│  ├── status: pending | in_progress | completed | failed     │
│  ├── startedAt: 开始时间                                    │
│  ├── completedAt: 完成时间                                  │
│  └── result: 执行结果（成功时的输出或失败原因）               │
│                                                             │
│  检查点配置                                                  │
│  ├── checkpoint.required: 是否需要人工确认                   │
│  ├── checkpoint.autoApproveRule: 自动通过规则               │
│  └── checkpoint.timeout: 等待确认超时时间                    │
│                                                             │
│  回滚信息                                                    │
│  ├── rollback.enabled: 是否支持回滚                         │
│  ├── rollback.snapshotId: 执行前的状态快照                  │
│  └── rollback.strategy: 回滚策略                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 事件类型分类

#### 操作事件（谁做了什么）

记录每个实际执行的操作：

| 事件类型 | 说明 | 关键数据 |
|---------|------|---------|
| RESOURCE_ACCESSED | 访问了某个资源 | resourceType, resourceId |
| RESOURCE_CREATED | 创建了新资源 | resourceType, resourceId, data |
| RESOURCE_UPDATED | 更新了资源 | resourceType, resourceId, changes |
| RESOURCE_DELETED | 删除了资源 | resourceType, resourceId |
| TASK_EXECUTED | 执行了测试任务 | taskId, config, result |

#### 流程事件（执行到哪了）

记录TODO List的执行进度：

| 事件类型 | 说明 | 关键数据 |
|---------|------|---------|
| TODO_PLANNED | 生成了执行计划 | goalDescription, items |
| TODO_ITEM_STARTED | 开始执行某项 | itemId |
| TODO_ITEM_COMPLETED | 完成了某项 | itemId, result |
| TODO_ITEM_FAILED | 某项执行失败 | itemId, error, willRetry |
| TODO_REPLANNED | 重新规划了计划 | reason, newItems |

#### 协作事件（人机交互）

记录人与AI之间的交互：

| 事件类型 | 说明 | 关键数据 |
|---------|------|---------|
| CHECKPOINT_REACHED | 到达检查点 | checkpointId, pendingAction |
| CHECKPOINT_APPROVED | 用户批准继续 | checkpointId |
| CHECKPOINT_REJECTED | 用户拒绝操作 | checkpointId, reason |
| CHECKPOINT_MODIFIED | 用户修改了计划 | checkpointId, modifications |
| CONTROL_TRANSFERRED | 控制权转移 | from, to, reason |

#### 上下文事件（记忆管理）

记录上下文的压缩和恢复：

| 事件类型 | 说明 | 关键数据 |
|---------|------|---------|
| CONTEXT_COMPACTED | 压缩了上下文 | beforeTokens, afterTokens, summary |
| CONTEXT_RESTORED | 恢复了上下文 | snapshotId |
| SESSION_STARTED | 开始新会话 | sessionId, initialContext |
| SESSION_ENDED | 结束会话 | sessionId, finalState |

---

## 三、系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户界面层 (UI Layer)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────┐   ┌─────────────────────────────┐    │
│   │        传统操作界面              │   │      AI Copilot 面板        │    │
│   │   (保持现有功能完整可用)         │   │   (可折叠的辅助面板)         │    │
│   │                                 │   │                             │    │
│   │  • 提示词管理                    │   │  • 当前理解展示              │    │
│   │  • 数据集管理                    │   │  • TODO List 可视化          │    │
│   │  • 模型配置                      │   │  • 检查点确认界面            │    │
│   │  • 评估器配置                    │   │  • 上下文状态指示            │    │
│   │  • 任务执行                      │   │  • 控制权切换按钮            │    │
│   │  • 结果分析                      │   │                             │    │
│   └─────────────────────────────────┘   └─────────────────────────────┘    │
│                │                                      │                     │
│                │  用户操作                    AI指令/确认                   │
│                ▼                                      ▼                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                          协调层 (Coordination Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                     Event Bus (事件总线)                             │  │
│   │         所有操作（无论来自用户还是AI）都通过事件总线                    │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│         ┌─────────────────────────┼─────────────────────────┐              │
│         │                         │                         │              │
│         ▼                         ▼                         ▼              │
│   ┌───────────┐           ┌───────────────┐         ┌───────────────┐     │
│   │  Event    │           │  Checkpoint   │         │    Context    │     │
│   │  Store    │           │  Controller   │         │    Manager    │     │
│   │           │           │               │         │               │     │
│   │ 持久化    │           │ 人机协作控制   │         │ 上下文压缩    │     │
│   │ 事件流    │           │ 检查点管理     │         │ 快照恢复      │     │
│   └───────────┘           └───────────────┘         └───────────────┘     │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                            AI层 (AI Layer) [可选启用]                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         Agent Loop                                   │  │
│   │                                                                      │  │
│   │    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    │  │
│   │    │  Plan    │───►│  Gather  │───►│   Act    │───►│  Verify  │    │  │
│   │    │  规划    │    │  收集    │    │  执行    │    │  验证    │    │  │
│   │    └──────────┘    └──────────┘    └──────────┘    └──────────┘    │  │
│   │         │                                               │           │  │
│   │         └───────────────────────────────────────────────┘           │  │
│   │                          (循环)                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                   │                                         │
│                                   │ 通过GOI接口                             │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      GOI Executor (GOI执行器)                        │  │
│   │                                                                      │  │
│   │    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │  │
│   │    │    Access    │  │    State     │  │ Observation  │            │  │
│   │    │    Handler   │  │    Handler   │  │    Handler   │            │  │
│   │    └──────────────┘  └──────────────┘  └──────────────┘            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                   │                                         │
│                                   │ 转换为API调用                           │
│                                   ▼                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                          核心API层 (Core API Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐  │
│   │  Prompt   │ │  Dataset  │ │   Model   │ │ Evaluator │ │   Task    │  │
│   │  Service  │ │  Service  │ │  Service  │ │  Service  │ │  Service  │  │
│   └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘  │
│                                                                             │
│                              (现有API保持不变)                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 三种运行模式

#### 模式一：纯人工模式

```
用户操作 ──► 传统UI ──► Event Bus ──► Core API
                           │
                           ▼
                      Event Store
                      (仅记录，不干预)
```

**特点**：
- AI层完全不参与
- 所有操作记录到事件流（便于后续分析或AI学习）
- 与升级前的系统体验完全一致

#### 模式二：AI辅助模式（推荐）

```
                    ┌──────────────────────────────────────┐
                    │          AI Copilot 面板             │
                    │  显示建议、TODO List、当前状态        │
                    └──────────────────┬───────────────────┘
                                       │
                    ┌──────────────────▼───────────────────┐
                    │         Checkpoint Controller        │
                    │   根据规则决定是否需要用户确认         │
                    └──────────────────┬───────────────────┘
                                       │
     用户操作 ──► 传统UI ──┐            │
                          │            │
                          ▼            ▼
                      Event Bus ◄── AI Agent (GOI)
                          │
                          ▼
                      Core API
```

**特点**：
- AI在侧边栏提供建议和执行计划
- 关键操作需要用户确认
- 用户随时可以直接操作传统UI
- 人工操作会同步更新AI的理解

#### 模式三：AI自动模式

```
用户设定目标 ──► Agent Loop ──► GOI Executor ──► Event Bus ──► Core API
                    │                               │
                    │◄────── 结果反馈 ◄──────────────┘
                    │
                    ▼
            自动执行直到完成或遇到异常
```

**特点**：
- 用户只需描述目标
- AI自动规划并执行所有步骤
- 仅在预设的检查点暂停
- 适用于重复性任务或用户信任度高的场景

### 3.3 组件职责说明

#### Event Bus（事件总线）

**职责**：
- 接收所有操作产生的事件
- 分发事件给订阅者
- 保证事件的顺序性和可靠性

**设计要点**：
- 使用 Redis Pub/Sub 实现跨进程通信（复用现有基础设施）
- 支持事件过滤，订阅者可以只关注特定类型的事件
- 支持事件重放，用于调试和恢复

#### Event Store（事件存储）

**职责**：
- 持久化所有事件
- 支持按时间范围查询
- 支持按会话ID查询
- 支持状态重建

**设计要点**：
- 使用 PostgreSQL 存储（复用现有数据库）
- 事件表设计支持快速时间范围查询
- 定期归档历史事件
- 保留关键事件的快照

#### Checkpoint Controller（检查点控制器）

**职责**：
- 判断当前操作是否需要人工确认
- 管理确认等待队列
- 处理超时和取消

**检查点规则设计**：

| 操作类型 | 默认策略 | 可配置 |
|---------|---------|-------|
| 观察类操作（查询、浏览） | 自动通过 | ✓ |
| 访问类操作（打开页面、切换Tab） | 自动通过 | ✓ |
| 创建类操作 | 需要确认 | ✓ |
| 更新类操作 | 智能判断* | ✓ |
| 删除类操作 | 必须确认 | ✗ |
| 执行类操作（运行任务） | 需要确认 | ✓ |

*智能判断：根据变更影响范围和用户历史行为决定

#### Context Manager（上下文管理器）

**职责**：
- 监控上下文使用量
- 触发和执行上下文压缩
- 管理上下文快照
- 支持上下文恢复

**压缩策略**：

```
上下文使用量监控
        │
        ├── < 70%: 正常运行
        │
        ├── 70% ~ 85%: 预警状态
        │   └── 提示用户可以手动压缩
        │
        ├── 85% ~ 95%: 自动压缩
        │   └── 执行智能压缩，保留关键信息
        │
        └── > 95%: 紧急压缩
            └── 激进压缩，可能丢失部分细节
```

**压缩时保留的信息**（按优先级）：

1. **必须保留**：当前目标、待执行的TODO项、已选择的资源ID
2. **尽量保留**：已完成的TODO项摘要、关键决策点、用户的特殊要求
3. **可以丢弃**：中间步骤的详细日志、API响应的原始数据、搜索结果列表

#### GOI Executor（GOI执行器）

**职责**：
- 解析GOI声明
- 转换为具体的API调用序列
- 执行并处理结果
- 错误重试和回滚

**执行流程**：

```
接收GOI声明
    │
    ▼
┌─────────────────────────────────────┐
│ 1. 解析声明类型（Access/State/Observation）│
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 2. 查询当前状态                      │
│    - 当前在哪个页面/模块             │
│    - 目标资源的当前状态              │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 3. 计算操作序列                      │
│    - 需要哪些导航操作                │
│    - 需要哪些数据变更                │
│    - 操作的依赖顺序                  │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 4. 创建状态快照（用于回滚）          │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 5. 逐个执行操作                      │
│    - 每个操作发布事件                │
│    - 失败时触发回滚                  │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 6. 验证最终状态                      │
│    - 确认达到期望状态                │
│    - 返回执行结果                    │
└─────────────────────────────────────┘
```

#### Agent Loop（代理循环）

**职责**：
- 理解用户目标
- 生成执行计划（TODO List）
- 驱动计划执行
- 处理异常和重规划

**循环流程**：

```
接收用户目标
    │
    ▼
┌─────────────────────────────────────┐
│ PLAN: 生成初始TODO List              │
│       - 分析目标                     │
│       - 拆分为原子操作               │
│       - 确定依赖关系                 │
│       - 设置检查点                   │
└──────────────────┬──────────────────┘
                   │
                   ▼
        ┌─────────────────────┐
        │  还有待执行的TODO？  │
        └──────────┬──────────┘
                   │
          ┌───────┴───────┐
          │ 是            │ 否
          ▼               ▼
┌─────────────────┐   ┌─────────────────┐
│ GATHER: 收集上下文│   │ 完成，生成报告   │
│ - 当前系统状态   │   └─────────────────┘
│ - 已执行结果     │
│ - 相关资源信息   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 需要人工确认？                       │
│ (根据Checkpoint规则判断)             │
└──────────────────┬──────────────────┘
                   │
          ┌───────┴───────┐
          │ 是            │ 否
          ▼               │
┌─────────────────┐       │
│ 等待用户决策     │       │
│ - 确认继续      │       │
│ - 修改计划      │       │
│ - 接管操作      │       │
└────────┬────────┘       │
         │                │
         ▼                │
    用户决策 ─────────────┤
         │                │
         ▼                ▼
┌─────────────────────────────────────┐
│ ACT: 执行当前TODO项                  │
│      通过GOI Executor执行            │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ VERIFY: 验证执行结果                 │
│ - 操作是否成功                       │
│ - 状态是否符合预期                   │
└──────────────────┬──────────────────┘
                   │
          ┌───────┴───────┐
          │ 成功          │ 失败
          ▼               ▼
┌─────────────────┐ ┌─────────────────┐
│ 标记TODO完成    │ │ 回滚到上一状态   │
│ 继续下一项      │ │ 分析失败原因     │
└────────┬────────┘ │ 决定重试/跳过/  │
         │          │ 重规划/报告用户  │
         │          └────────┬────────┘
         │                   │
         └───────────────────┘
                   │
                   ▼
            返回循环起点
```

---

## 四、TODO List 细粒度设计

### 4.1 业务操作拆分原则

**原则一：单一职责**
每个TODO项只做一件事，且这件事是可独立成功或失败的。

**原则二：可观测**
每个TODO项的开始和结束都应该在UI上有明确的体现。

**原则三：可回滚**
每个TODO项执行前能创建快照，失败时能恢复。

**原则四：可跳过**
如果某个TODO项不是关键依赖，应该支持跳过继续执行后续项。

### 4.2 操作拆分示例

#### 示例一：创建并执行一个测试任务

用户目标："用 sentiment-v2 提示词和 test-data 数据集运行一个测试"

拆分后的TODO List：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TODO List: 创建并执行测试任务                                               │
│  目标: 用 sentiment-v2 提示词和 test-data 数据集运行一个测试                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ═══ 阶段1: 资源定位 ═══                                                    │
│                                                                             │
│  □ 1.1 进入任务创建页面                                                     │
│        类型: access                                                         │
│        操作: 导航到 /tasks/new                                              │
│        检查点: 否                                                           │
│                                                                             │
│  □ 1.2 打开提示词选择器                                                     │
│        类型: access                                                         │
│        操作: 点击提示词选择区域                                              │
│        检查点: 否                                                           │
│                                                                             │
│  □ 1.3 搜索目标提示词                                                       │
│        类型: state                                                          │
│        操作: 在搜索框输入 "sentiment-v2"                                    │
│        检查点: 否                                                           │
│                                                                             │
│  □ 1.4 选中提示词                                                           │
│        类型: state                                                          │
│        操作: 从搜索结果中选择匹配项                                          │
│        检查点: 是 (确认选择正确的提示词)                                     │
│        依赖: 1.3                                                            │
│                                                                             │
│  □ 1.5 确认提示词选择                                                       │
│        类型: state                                                          │
│        操作: 点击确认按钮关闭选择器                                          │
│        检查点: 否                                                           │
│        依赖: 1.4                                                            │
│                                                                             │
│  ═══ 阶段2: 数据集配置 ═══                                                  │
│                                                                             │
│  □ 2.1 打开数据集选择器                                                     │
│        类型: access                                                         │
│        操作: 点击数据集选择区域                                              │
│        检查点: 否                                                           │
│        依赖: 1.5                                                            │
│                                                                             │
│  □ 2.2 搜索目标数据集                                                       │
│        类型: state                                                          │
│        操作: 在搜索框输入 "test-data"                                       │
│        检查点: 否                                                           │
│                                                                             │
│  □ 2.3 选中数据集                                                           │
│        类型: state                                                          │
│        操作: 从搜索结果中选择匹配项                                          │
│        检查点: 是 (确认数据集匹配)                                           │
│        依赖: 2.2                                                            │
│                                                                             │
│  □ 2.4 确认数据集选择                                                       │
│        类型: state                                                          │
│        操作: 点击确认按钮关闭选择器                                          │
│        检查点: 否                                                           │
│        依赖: 2.3                                                            │
│                                                                             │
│  ═══ 阶段3: 字段映射（如果需要）═══                                         │
│                                                                             │
│  □ 3.1 检查是否需要字段映射                                                 │
│        类型: observation                                                    │
│        操作: 获取提示词的InputSchema和数据集的字段列表                       │
│        检查点: 否                                                           │
│        依赖: 2.4                                                            │
│                                                                             │
│  □ 3.2 打开字段映射配置（条件执行）                                         │
│        类型: access                                                         │
│        操作: 点击"配置字段映射"按钮                                         │
│        条件: 3.1结果显示需要映射                                            │
│        检查点: 否                                                           │
│                                                                             │
│  □ 3.3 配置输入字段映射（条件执行）                                         │
│        类型: state                                                          │
│        操作: 为每个输入变量选择对应的数据集字段                              │
│        条件: 3.2已执行                                                      │
│        检查点: 是 (确认映射正确)                                            │
│                                                                             │
│  □ 3.4 保存字段映射（条件执行）                                             │
│        类型: state                                                          │
│        操作: 点击保存按钮                                                   │
│        条件: 3.3已执行                                                      │
│        检查点: 否                                                           │
│                                                                             │
│  ═══ 阶段4: 评估器配置 ═══                                                  │
│                                                                             │
│  □ 4.1 打开评估器配置                                                       │
│        类型: access                                                         │
│        操作: 展开评估器配置区域                                              │
│        检查点: 否                                                           │
│        依赖: 3.1 或 3.4                                                     │
│                                                                             │
│  □ 4.2 检查是否有预设评估器                                                 │
│        类型: observation                                                    │
│        操作: 获取OutputSchema中的评估器配置                                  │
│        检查点: 否                                                           │
│                                                                             │
│  □ 4.3 确认评估器配置                                                       │
│        类型: state                                                          │
│        操作: 使用预设配置或选择默认评估器                                    │
│        检查点: 是 (确认评估方式合适)                                        │
│                                                                             │
│  ═══ 阶段5: 执行任务 ═══                                                    │
│                                                                             │
│  □ 5.1 校验任务配置                                                         │
│        类型: observation                                                    │
│        操作: 检查所有必填项是否完整                                          │
│        检查点: 否                                                           │
│        依赖: 4.3                                                            │
│                                                                             │
│  □ 5.2 创建任务                                                             │
│        类型: state                                                          │
│        操作: 点击"创建任务"按钮                                             │
│        检查点: 是 (最后确认是否执行)                                        │
│        依赖: 5.1 (校验通过)                                                 │
│                                                                             │
│  □ 5.3 启动任务执行                                                         │
│        类型: state                                                          │
│        操作: 点击"开始执行"按钮                                             │
│        检查点: 否                                                           │
│        依赖: 5.2                                                            │
│                                                                             │
│  □ 5.4 等待执行完成                                                         │
│        类型: observation                                                    │
│        操作: 轮询任务状态直到完成                                           │
│        检查点: 否                                                           │
│        依赖: 5.3                                                            │
│                                                                             │
│  ═══ 阶段6: 结果汇报 ═══                                                    │
│                                                                             │
│  □ 6.1 获取执行结果摘要                                                     │
│        类型: observation                                                    │
│        操作: 获取任务的通过率、耗时等统计信息                               │
│        检查点: 否                                                           │
│        依赖: 5.4                                                            │
│                                                                             │
│  □ 6.2 生成执行报告                                                         │
│        类型: observation                                                    │
│        操作: 整理结果并向用户汇报                                           │
│        检查点: 否                                                           │
│        依赖: 6.1                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 示例二：配置一个新的输出Schema

用户目标："为客服场景的提示词创建一个输出结构，包含问题分类、回答内容、置信度三个字段"

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TODO List: 创建客服场景OutputSchema                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ═══ 阶段1: 进入Schema管理 ═══                                              │
│                                                                             │
│  □ 1.1 进入Schema管理页面                                                   │
│        类型: access                                                         │
│        操作: 导航到 /schemas                                                │
│                                                                             │
│  □ 1.2 切换到OutputSchema标签                                               │
│        类型: access                                                         │
│        操作: 点击"输出结构"Tab                                              │
│                                                                             │
│  □ 1.3 点击新建按钮                                                         │
│        类型: access                                                         │
│        操作: 点击"新建输出结构"按钮                                         │
│                                                                             │
│  ═══ 阶段2: 基础信息配置 ═══                                                │
│                                                                             │
│  □ 2.1 填写Schema名称                                                       │
│        类型: state                                                          │
│        操作: 输入"客服场景输出结构"                                         │
│                                                                             │
│  □ 2.2 填写Schema描述                                                       │
│        类型: state                                                          │
│        操作: 输入描述信息                                                   │
│                                                                             │
│  ═══ 阶段3: 字段定义 ═══                                                    │
│                                                                             │
│  □ 3.1 添加"问题分类"字段                                                   │
│        类型: state                                                          │
│        子步骤:                                                              │
│        - 3.1.1 点击"添加字段"按钮                                           │
│        - 3.1.2 输入字段名称: problem_type                                   │
│        - 3.1.3 选择类型: enum                                               │
│        - 3.1.4 添加枚举值: ["咨询","投诉","建议","其他"]                     │
│        - 3.1.5 勾选"必填"                                                   │
│        - 3.1.6 配置评估器: preset-exact-match                               │
│        - 3.1.7 设置权重: 0.4                                                │
│        - 3.1.8 标记为关键字段                                               │
│        检查点: 是 (确认字段配置)                                            │
│                                                                             │
│  □ 3.2 添加"回答内容"字段                                                   │
│        类型: state                                                          │
│        子步骤:                                                              │
│        - 3.2.1 点击"添加字段"按钮                                           │
│        - 3.2.2 输入字段名称: answer                                         │
│        - 3.2.3 选择类型: string                                             │
│        - 3.2.4 勾选"必填"                                                   │
│        - 3.2.5 配置评估器: llm-quality-check                                │
│        - 3.2.6 设置权重: 0.4                                                │
│        检查点: 是                                                           │
│                                                                             │
│  □ 3.3 添加"置信度"字段                                                     │
│        类型: state                                                          │
│        子步骤:                                                              │
│        - 3.3.1 点击"添加字段"按钮                                           │
│        - 3.3.2 输入字段名称: confidence                                     │
│        - 3.3.3 选择类型: number                                             │
│        - 3.3.4 勾选"必填"                                                   │
│        - 3.3.5 不配置评估器（仅记录）                                       │
│        - 3.3.6 设置权重: 0.2                                                │
│        检查点: 否                                                           │
│                                                                             │
│  ═══ 阶段4: 聚合配置 ═══                                                    │
│                                                                             │
│  □ 4.1 配置聚合策略                                                         │
│        类型: state                                                          │
│        操作: 选择"关键字段优先"模式                                         │
│        检查点: 是 (确认聚合方式)                                            │
│                                                                             │
│  ═══ 阶段5: 保存 ═══                                                        │
│                                                                             │
│  □ 5.1 校验配置完整性                                                       │
│        类型: observation                                                    │
│        操作: 检查所有必填项和字段配置                                       │
│                                                                             │
│  □ 5.2 保存Schema                                                           │
│        类型: state                                                          │
│        操作: 点击"保存"按钮                                                 │
│        检查点: 是 (最终确认)                                                │
│                                                                             │
│  □ 5.3 返回列表确认创建成功                                                 │
│        类型: observation                                                    │
│        操作: 确认新Schema出现在列表中                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 TODO状态机

```
                    ┌─────────────┐
                    │   pending   │
                    │   (待执行)   │
                    └──────┬──────┘
                           │
                           │ 开始执行
                           ▼
                    ┌─────────────┐
          ┌────────│ in_progress │────────┐
          │        │   (执行中)   │        │
          │        └─────────────┘        │
          │                               │
          │ 需要确认                        │ 执行完成
          ▼                               │
   ┌─────────────┐                        │
   │   waiting   │                        │
   │  (等待确认)  │                        │
   └──────┬──────┘                        │
          │                               │
    ┌─────┼─────┐                         │
    │     │     │                         │
 批准  修改  拒绝                          │
    │     │     │                         │
    │     │     ▼                         │
    │     │ ┌─────────────┐              │
    │     │ │  rejected   │              │
    │     │ │   (已拒绝)   │              │
    │     │ └─────────────┘              │
    │     │                               │
    │     ▼                               │
    │ ┌─────────────┐                     │
    │ │  replanned  │                     │
    │ │  (已重规划)  │──► 生成新的TODO List │
    │ └─────────────┘                     │
    │                                     │
    ▼                                     ▼
┌───────────────────────────────────────────┐
│              执行操作                      │
└─────────────────┬─────────────────────────┘
                  │
          ┌───────┴───────┐
          │               │
       成功             失败
          │               │
          ▼               ▼
   ┌─────────────┐ ┌─────────────┐
   │  completed  │ │   failed    │
   │   (已完成)   │ │   (已失败)   │
   └─────────────┘ └──────┬──────┘
                          │
                  ┌───────┴───────┐
                  │               │
               可重试          不可重试
                  │               │
                  ▼               ▼
           返回pending       标记skipped
                          ┌─────────────┐
                          │   skipped   │
                          │   (已跳过)   │
                          └─────────────┘
```

---

## 五、失败处理与回滚机制

### 5.1 失败分类

| 失败类型 | 说明 | 处理策略 |
|---------|------|---------|
| **临时性失败** | 网络超时、服务暂时不可用 | 自动重试（最多3次） |
| **数据性失败** | 资源不存在、数据校验不通过 | 回滚并报告用户 |
| **逻辑性失败** | 操作前置条件不满足 | 尝试重规划 |
| **权限性失败** | 无权限执行某操作 | 回滚并报告用户 |
| **系统性失败** | 服务崩溃、数据库异常 | 回滚并告警 |

### 5.2 回滚机制设计

#### 快照时机

在以下时刻自动创建状态快照：

1. **TODO List 生成后**：记录初始状态
2. **每个 TODO 项开始前**：记录执行前状态
3. **检查点通过后**：记录确认后状态
4. **上下文压缩后**：记录压缩后状态

#### 快照内容

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            状态快照 (Snapshot)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  元信息                                                                      │
│  ├── snapshotId: 快照唯一标识                                               │
│  ├── timestamp: 创建时间                                                    │
│  ├── trigger: 触发原因 (todo_start | checkpoint | compact)                  │
│  └── todoItemId: 关联的TODO项（如果有）                                      │
│                                                                             │
│  会话状态                                                                    │
│  ├── currentPage: 当前所在页面/路由                                          │
│  ├── openDialogs: 当前打开的弹窗列表                                         │
│  ├── formStates: 各表单的当前值                                              │
│  └── selectedItems: 当前选中的资源                                          │
│                                                                             │
│  TODO状态                                                                    │
│  ├── todoListId: TODO List ID                                               │
│  ├── completedItems: 已完成项ID列表                                         │
│  ├── currentItemIndex: 当前执行到第几项                                      │
│  └── itemResults: 各项的执行结果                                            │
│                                                                             │
│  资源状态（差异记录）                                                        │
│  ├── createdResources: 本次会话创建的资源ID                                  │
│  ├── modifiedResources: 本次会话修改的资源                                   │
│  │   └── [resourceId]: { before: {...}, after: {...} }                     │
│  └── deletedResources: 本次会话删除的资源（保留副本）                        │
│                                                                             │
│  上下文状态                                                                  │
│  ├── contextSummary: 压缩后的上下文摘要                                      │
│  └── tokenUsage: 当前token使用量                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 回滚流程

```
检测到失败
    │
    ▼
┌─────────────────────────────────────┐
│ 1. 立即停止后续TODO项执行             │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 2. 确定回滚目标快照                  │
│    - 默认：当前TODO项开始前的快照     │
│    - 如果该快照不可用：上一个检查点快照│
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 3. 执行状态回滚                      │
│    - 撤销已创建的资源                │
│    - 恢复已修改的资源                │
│    - 恢复已删除的资源                │
│    - 恢复UI状态（页面、弹窗）         │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 4. 更新TODO List状态                 │
│    - 标记失败项                      │
│    - 更新进度                        │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 5. 生成失败报告                      │
│    - 失败原因分析                    │
│    - 已回滚的操作                    │
│    - 建议的下一步                    │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 6. 通知用户                          │
│    - 在Copilot面板显示失败信息       │
│    - 提供选项：重试/跳过/重规划/放弃  │
└─────────────────────────────────────┘
```

### 5.3 失败报告模板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ⚠️ 任务执行失败                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 📍 失败位置                                                                 │
│    TODO项: "选中数据集"                                                     │
│    阶段: 数据集配置 (第3项，共12项)                                          │
│                                                                             │
│ ❌ 失败原因                                                                 │
│    搜索 "test-data" 未找到匹配的数据集                                       │
│    可能的原因：                                                             │
│    • 数据集名称拼写错误                                                     │
│    • 数据集已被删除                                                         │
│    • 当前用户无权限访问该数据集                                              │
│                                                                             │
│ 🔄 已执行的回滚                                                             │
│    • 关闭了数据集选择器                                                     │
│    • 清除了搜索条件                                                         │
│    • 状态已恢复到"选择提示词"完成后                                          │
│                                                                             │
│ 💡 建议操作                                                                 │
│    ┌────────────────────────────────────────────────────────────────┐      │
│    │ [重新搜索] 尝试其他关键词搜索数据集                              │      │
│    │ [手动选择] 我来手动选择数据集                                    │      │
│    │ [跳过此步] 暂时跳过，稍后配置                                    │      │
│    │ [放弃任务] 取消本次任务创建                                      │      │
│    └────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、上下文管理策略

### 6.1 上下文分层模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          上下文层级结构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 第1层：系统常量（始终存在，约2K tokens）                              │   │
│  │                                                                     │   │
│  │ • 平台能力说明（支持哪些操作）                                        │   │
│  │ • GOI接口定义                                                        │   │
│  │ • 行为准则（安全规范、确认规则）                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 第2层：会话上下文（可压缩，约5-20K tokens）                           │   │
│  │                                                                     │   │
│  │ • 用户原始目标                                                       │   │
│  │ • TODO List 当前状态                                                 │   │
│  │ • 已完成操作的摘要                                                   │   │
│  │ • 关键决策记录                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 第3层：工作上下文（高度动态，约3-10K tokens）                         │   │
│  │                                                                     │   │
│  │ • 当前TODO项的详细信息                                               │   │
│  │ • 最近几次操作的结果                                                 │   │
│  │ • 当前页面/弹窗状态                                                  │   │
│  │ • 临时查询结果                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 第4层：即时上下文（每次请求临时注入，约1-5K tokens）                   │   │
│  │                                                                     │   │
│  │ • 当前步骤的系统提醒                                                 │   │
│  │ • 检查点信息（如果有）                                               │   │
│  │ • 错误信息（如果有）                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 压缩触发条件

| 条件 | 触发动作 | 压缩级别 |
|------|---------|---------|
| 上下文 > 70% | 显示预警，建议用户手动压缩 | - |
| 上下文 > 85% | 自动触发压缩 | 标准压缩 |
| 上下文 > 90% | 立即压缩 | 深度压缩 |
| 完成一个阶段（多个TODO项） | 可选压缩 | 阶段压缩 |
| 检查点通过后 | 可选压缩 | 检查点压缩 |
| 用户手动触发 | 执行压缩 | 用户指定 |

### 6.3 压缩级别说明

#### 标准压缩（保留率约60%）

- 保留：目标、TODO List、所有决策点、最近3个操作详情
- 压缩：早期操作详情改为摘要
- 丢弃：中间查询结果、重复信息

#### 深度压缩（保留率约30%）

- 保留：目标、TODO List状态、关键决策
- 压缩：所有操作改为一句话摘要
- 丢弃：操作详情、查询结果

#### 阶段压缩（完成一个阶段后）

- 保留：阶段完成状态、产出物ID
- 压缩：整个阶段的操作合并为一段摘要
- 丢弃：阶段内的中间状态

### 6.4 压缩摘要模板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          上下文压缩摘要                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 【会话目标】                                                                 │
│ 用户要创建一个测试任务，使用 sentiment-v2 提示词和 test-data 数据集          │
│                                                                             │
│ 【已完成工作】                                                               │
│ ✅ 阶段1-资源定位（5项）: 已选择 sentiment-v2 提示词                         │
│ ✅ 阶段2-数据集配置（4项）: 已选择 test-data 数据集，100条数据               │
│ ⏳ 阶段3-字段映射: 进行中                                                   │
│                                                                             │
│ 【当前状态】                                                                 │
│ • 页面: /tasks/new                                                          │
│ • 已选资源:                                                                 │
│   - promptId: "prompt-uuid-123"                                            │
│   - datasetId: "dataset-uuid-456"                                          │
│ • 待配置: 字段映射、评估器                                                   │
│                                                                             │
│ 【关键决策】                                                                 │
│ • 用户确认选择 sentiment-v2（而非 sentiment-v1）                             │
│ • 数据集映射方式选择"自动推断"                                               │
│                                                                             │
│ 【下一步】                                                                   │
│ 继续执行 TODO #3.3: 配置输入字段映射                                         │
│                                                                             │
│ 【约束条件】                                                                 │
│ • 用户要求使用精确匹配评估器                                                 │
│ • 不需要配置LLM评估                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、人机协作界面设计

### 7.1 AI Copilot 面板布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                主界面                                        │
├────────────────────────────────────────────────┬────────────────────────────┤
│                                                │                            │
│                                                │   🤖 AI Copilot            │
│                                                │   ──────────────────       │
│                                                │                            │
│           传统操作界面                          │   💭 当前理解              │
│                                                │   ┌──────────────────┐    │
│           (保持原有布局不变)                     │   │ 用户正在创建测   │    │
│                                                │   │ 试任务...        │    │
│                                                │   └──────────────────┘    │
│                                                │                            │
│                                                │   📋 任务计划 (3/12)       │
│                                                │   ┌──────────────────┐    │
│                                                │   │ ✅ 选择提示词     │    │
│                                                │   │ ✅ 打开数据集选择 │    │
│                                                │   │ 🔧 搜索数据集     │    │
│                                                │   │ ⏳ 选中数据集     │    │
│                                                │   │ ⏳ ...            │    │
│                                                │   └──────────────────┘    │
│                                                │                            │
│                                                │   ⏸️ 等待确认              │
│                                                │   ┌──────────────────┐    │
│                                                │   │ 确认选择数据集:   │    │
│                                                │   │ test-data        │    │
│                                                │   │                  │    │
│                                                │   │ [确认] [换一个]   │    │
│                                                │   └──────────────────┘    │
│                                                │                            │
│                                                │   上下文: ████████░░ 78%  │
│                                                │                            │
│                                                │   ──────────────────       │
│                                                │   [💬 输入指令...]         │
│                                                │                            │
│                                                │   ○逐步 ●智能 ○全自动     │
│                                                │                            │
└────────────────────────────────────────────────┴────────────────────────────┘
```

### 7.2 检查点确认交互

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          检查点确认                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  📍 当前操作：选择数据集                                                     │
│                                                                             │
│  AI 打算选择以下数据集：                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  📊 test-data                                                       │   │
│  │                                                                     │   │
│  │  描述：情感分析测试数据集                                             │   │
│  │  数据量：100 条                                                      │   │
│  │  字段：text, sentiment, confidence                                   │   │
│  │  创建时间：2024-12-01                                                │   │
│  │                                                                     │   │
│  │  [预览数据]                                                          │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  请确认是否继续：                                                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  [✅ 确认继续]    [✏️ 换一个数据集]    [✋ 我来操作]    [❌ 取消]    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  💡 提示：选择"我来操作"后，您可以手动完成此步骤，AI会继续后续任务            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 实时同步机制

**人工操作 → AI感知**：

```
用户在传统UI执行操作
        │
        ▼
操作通过 Event Bus 发布事件
        │
        ▼
AI Copilot 订阅事件更新
        │
        ├── 更新"当前理解"面板
        │
        ├── 检查是否影响当前TODO
        │   ├── 是：标记TODO为已完成/调整计划
        │   └── 否：仅记录
        │
        └── 更新TODO List显示
```

**AI操作 → UI反映**：

```
AI 通过 GOI 执行操作
        │
        ▼
GOI Executor 调用 Core API
        │
        ▼
API 触发 UI 状态变更
        │
        ├── 页面导航（如果需要）
        │
        ├── 表单填充（如果需要）
        │
        └── 弹窗打开/关闭（如果需要）
        │
        ▼
用户在传统UI看到"幽灵操作"效果
（可选：添加视觉提示表明这是AI操作）
```

### 7.4 控制权切换

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         控制权状态                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  AI 主导模式                        人工主导模式                             │
│  ┌───────────────────────┐        ┌───────────────────────┐               │
│  │                       │        │                       │               │
│  │  AI 按计划执行        │   切换  │  用户自由操作         │               │
│  │  用户监督确认         │ ◄────► │  AI 观察学习          │               │
│  │  [交给我来] 按钮      │        │  [继续执行] 按钮       │               │
│  │                       │        │                       │               │
│  └───────────────────────┘        └───────────────────────┘               │
│                                                                             │
│  切换时机：                                                                  │
│  • 用户点击"我来操作"：AI → 人工                                             │
│  • 用户点击"继续执行"：人工 → AI                                             │
│  • 检查点被拒绝：AI → 人工                                                  │
│  • 人工操作完成TODO项：可选择让AI继续                                        │
│                                                                             │
│  切换时AI行为：                                                              │
│  • AI → 人工：AI暂停执行，持续观察用户操作，更新状态理解                      │
│  • 人工 → AI：AI获取最新状态，调整计划（如需要），继续执行                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、模型选择与调用策略

### 8.1 任务-模型匹配

| 任务类型 | 能力要求 | 推荐模型 | 调用频率 |
|---------|---------|---------|---------|
| **目标理解与计划生成** | 强推理、理解复杂指令 | Claude Sonnet 4 / GPT-4o | 每次新任务1次 |
| **TODO执行决策** | 中等推理、结构化输出 | Claude Sonnet 4 / GPT-4o | 每个TODO项1次 |
| **状态理解更新** | 快速理解、轻量推理 | Claude Haiku / GPT-4o-mini | 每次用户操作后 |
| **上下文压缩** | 摘要能力、信息提取 | Claude Haiku / GPT-4o-mini | 压缩触发时 |
| **失败分析** | 诊断推理 | Claude Sonnet 4 | 失败发生时 |
| **重规划** | 强推理、计划调整 | Claude Sonnet 4 / GPT-4o | 需要时 |

### 8.2 调用优化策略

#### 策略一：延迟合并

```
多个连续的观察请求
        │
        ▼
┌─────────────────────────────────────┐
│ 等待50ms，收集更多请求              │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│ 合并为单次批量查询                   │
└─────────────────────────────────────┘
```

#### 策略二：结果缓存

对于同一会话内重复的查询（如检查某资源是否存在），缓存结果：

- 缓存时间：根据资源类型不同（配置类1分钟，状态类10秒）
- 缓存失效：相关资源发生变更事件时

#### 策略三：流式响应

对于长时间运行的生成任务（如计划生成），使用流式响应：

- 前端可以逐步显示结果
- 用户可以在生成过程中取消
- 减少等待时的焦虑感

### 8.3 成本控制

| 控制措施 | 说明 |
|---------|------|
| 模型降级 | 简单任务使用便宜模型，复杂任务才用强模型 |
| 上下文精简 | 只传递必要信息，避免冗余 |
| 请求合并 | 减少请求次数 |
| 缓存复用 | 避免重复查询 |
| 用量监控 | 设置预算告警 |

---

## 九、实施路线图

### 9.1 总体规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            实施路线图（预计12周）                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 0: 基础设施准备                                          2周          │
│  ════════════════════════════════════════════════════════════════          │
│  ├── Week 1: 事件系统设计与实现                                             │
│  └── Week 2: 状态快照机制实现                                               │
│                                                                             │
│  Phase 1: GOI 核心能力                                          3周          │
│  ════════════════════════════════════════════════════════════════          │
│  ├── Week 3: GOI 接口定义与执行器                                           │
│  ├── Week 4: TODO List 系统                                                │
│  └── Week 5: Agent Loop 实现                                               │
│                                                                             │
│  Phase 2: 人机协作系统                                          3周          │
│  ════════════════════════════════════════════════════════════════          │
│  ├── Week 6: Checkpoint Controller                                         │
│  ├── Week 7: AI Copilot 面板 UI                                            │
│  └── Week 8: 实时同步与控制权切换                                           │
│                                                                             │
│  Phase 3: 上下文与可靠性                                        2周          │
│  ════════════════════════════════════════════════════════════════          │
│  ├── Week 9: 上下文管理与压缩                                              │
│  └── Week 10: 回滚机制与失败处理                                           │
│                                                                             │
│  Phase 4: 集成与优化                                            2周          │
│  ════════════════════════════════════════════════════════════════          │
│  ├── Week 11: 全流程集成测试                                               │
│  └── Week 12: 性能优化与上线准备                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 详细任务分解

#### Phase 0: 基础设施准备（Week 1-2）

**Week 1: 事件系统设计与实现**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 事件类型定义 | 定义所有操作事件、流程事件、协作事件的数据结构 | 1d |
| Event Bus 实现 | 基于 Redis Pub/Sub 实现事件总线 | 1d |
| Event Store 实现 | PostgreSQL 事件表设计与存储实现 | 1d |
| 现有 API 改造 | 在现有 Service 层添加事件发布逻辑 | 2d |

**Week 2: 状态快照机制实现**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 快照数据结构设计 | 定义快照包含的状态信息 | 0.5d |
| 快照创建逻辑 | 实现状态收集与快照保存 | 1d |
| 快照恢复逻辑 | 实现从快照恢复状态 | 1d |
| 快照管理 API | 快照的 CRUD 接口 | 1d |
| 自动清理机制 | 过期快照的清理策略 | 0.5d |

**Phase 0 交付物**：
- ✅ 完整的事件类型定义
- ✅ 可用的事件总线（支持跨进程）
- ✅ 事件持久化存储
- ✅ 现有 API 已接入事件发布
- ✅ 快照创建与恢复功能

---

#### Phase 1: GOI 核心能力（Week 3-5）

**Week 3: GOI 接口定义与执行器**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| GOI 接口定义 | 定义 Access/State/Observation 三类声明的数据结构 | 1d |
| Access Handler | 实现资源访问的声明式处理（导航、打开） | 1.5d |
| State Handler | 实现状态变更的声明式处理（创建、更新、删除） | 1.5d |
| Observation Handler | 实现信息查询的声明式处理 | 1d |

**Week 4: TODO List 系统**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| TODO Item 数据结构 | 定义 TODO 项的完整结构 | 0.5d |
| TODO List 管理 | 创建、更新、查询 TODO List | 1d |
| TODO 状态机 | 实现状态流转逻辑 | 1d |
| 依赖关系处理 | 处理 TODO 项之间的依赖 | 1d |
| 条件执行逻辑 | 支持条件跳过某些 TODO 项 | 0.5d |

**Week 5: Agent Loop 实现**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| Plan 阶段 | 实现目标理解和 TODO List 生成 | 1.5d |
| Gather 阶段 | 实现上下文收集逻辑 | 0.5d |
| Act 阶段 | 实现 GOI 执行调用 | 1d |
| Verify 阶段 | 实现执行结果验证 | 0.5d |
| 循环控制 | 实现完整的循环流程 | 1d |
| 系统提醒注入 | 根据状态生成提醒信息 | 0.5d |

**Phase 1 交付物**：
- ✅ GOI 三种声明类型可正常解析和执行
- ✅ TODO List 可创建、管理、持久化
- ✅ Agent Loop 可以执行简单任务（无人工干预）
- ✅ 基础的计划生成能力

---

#### Phase 2: 人机协作系统（Week 6-8）

**Week 6: Checkpoint Controller**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 检查点规则引擎 | 实现规则匹配和策略判断 | 1.5d |
| 等待队列管理 | 实现确认等待和超时处理 | 1d |
| 决策处理逻辑 | 处理用户的确认/修改/拒绝 | 1d |
| WebSocket 通信 | 实现前后端实时通信 | 1d |
| 检查点规则配置 | 支持用户自定义规则 | 0.5d |

**Week 7: AI Copilot 面板 UI**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 面板布局组件 | 可折叠的侧边栏面板 | 1d |
| 当前理解展示 | AI 状态理解的展示组件 | 0.5d |
| TODO List 可视化 | TODO 列表的展示和状态更新 | 1.5d |
| 检查点确认 UI | 确认弹窗和选项按钮 | 1d |
| 上下文指示器 | 上下文使用量的可视化 | 0.5d |
| 输入指令框 | 用户与 AI 的对话输入 | 0.5d |

**Week 8: 实时同步与控制权切换**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 人工操作感知 | AI 监听用户操作事件 | 1d |
| 状态理解更新 | 根据用户操作更新 AI 理解 | 1d |
| AI 操作 UI 反映 | GOI 操作触发 UI 变更 | 1d |
| 控制权切换逻辑 | 实现双向切换流程 | 1d |
| 模式选择 UI | 逐步/智能/全自动模式切换 | 0.5d |

**Phase 2 交付物**：
- ✅ 检查点系统可正常工作
- ✅ AI Copilot 面板 UI 完整
- ✅ 人机操作可双向同步
- ✅ 三种运行模式可切换

---

#### Phase 3: 上下文与可靠性（Week 9-10）

**Week 9: 上下文管理与压缩**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 上下文监控 | Token 计数和使用量追踪 | 0.5d |
| 压缩触发器 | 实现各级别的触发条件 | 0.5d |
| 压缩摘要生成 | 调用模型生成压缩摘要 | 1d |
| 上下文重建 | 从摘要 + 快照重建上下文 | 1d |
| 手动压缩 UI | 用户主动压缩的交互 | 0.5d |
| 压缩效果展示 | 压缩前后的对比显示 | 0.5d |

**Week 10: 回滚机制与失败处理**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 失败分类器 | 识别失败类型 | 0.5d |
| 回滚执行器 | 执行状态回滚 | 1.5d |
| 失败报告生成 | 生成用户可读的失败报告 | 1d |
| 重试策略 | 实现自动重试逻辑 | 0.5d |
| 失败恢复 UI | 失败后的用户选项界面 | 1d |

**Phase 3 交付物**：
- ✅ 上下文可自动压缩，不丢失关键信息
- ✅ 失败可自动回滚到安全状态
- ✅ 用户收到清晰的失败报告和选项

---

#### Phase 4: 集成与优化（Week 11-12）

**Week 11: 全流程集成测试**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| E2E 测试用例编写 | 覆盖主要使用场景 | 2d |
| 边界条件测试 | 失败、超时、中断等场景 | 1d |
| 性能基准测试 | 响应时间、资源消耗 | 1d |
| Bug 修复 | 修复测试发现的问题 | 1d |

**Week 12: 性能优化与上线准备**

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 性能优化 | 根据测试结果优化 | 2d |
| 文档编写 | 用户指南、开发文档 | 1d |
| 灰度发布准备 | 功能开关、监控告警 | 1d |
| 上线 | 正式发布 | 1d |

**Phase 4 交付物**：
- ✅ 全功能通过测试
- ✅ 性能达标
- ✅ 文档完整
- ✅ 正式上线

---

### 9.3 关键里程碑

| 里程碑 | 时间点 | 验收标准 |
|--------|--------|---------|
| M1: 基础设施就绪 | Week 2 末 | 事件系统可用，现有功能不受影响 |
| M2: GOI 原型可用 | Week 5 末 | 可以用 GOI 执行简单任务 |
| M3: 人机协作可用 | Week 8 末 | 可以在三种模式下工作 |
| M4: 可靠性保障 | Week 10 末 | 失败可恢复，上下文可管理 |
| M5: 正式上线 | Week 12 末 | 全功能可用，稳定运行 |

---

## 十、风险与应对

### 10.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 事件系统影响现有性能 | 高 | 中 | 异步发布、批量写入、监控预警 |
| 模型响应不稳定 | 高 | 中 | 重试机制、降级策略、缓存 |
| 上下文压缩丢失关键信息 | 高 | 低 | 多级压缩、关键信息标记、用户确认 |
| 实时同步延迟 | 中 | 中 | WebSocket 优化、状态合并、冲突解决 |

### 10.2 产品风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 用户不信任 AI 操作 | 高 | 中 | 充分透明、随时可控、渐进式引导 |
| 检查点过多影响效率 | 中 | 中 | 智能判断、规则可配置、记住用户偏好 |
| 学习成本过高 | 中 | 低 | 三种模式平滑切换、新手引导、帮助文档 |

### 10.3 资源风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 模型调用成本超预算 | 中 | 中 | 成本监控、模型降级、调用优化 |
| 开发周期延长 | 中 | 中 | 分阶段交付、MVP 先行、持续集成 |

---

## 十一、成功标准

### 11.1 功能指标

| 指标 | 目标 | 衡量方式 |
|------|------|---------|
| AI 任务完成率 | > 80% | 成功完成的任务数 / 总任务数 |
| 平均交互次数 | < 5 | 完成一个任务所需的人工确认次数 |
| 回滚成功率 | > 95% | 成功回滚的失败任务 / 总失败任务 |
| 上下文压缩保真率 | > 90% | 压缩后仍能继续执行的任务比例 |

### 11.2 性能指标

| 指标 | 目标 | 衡量方式 |
|------|------|---------|
| TODO 生成延迟 | < 5s | 从输入目标到 TODO List 显示 |
| 单步执行延迟 | < 2s | 单个 TODO 项的执行时间（不含模型调用） |
| UI 同步延迟 | < 200ms | 操作到 UI 更新的延迟 |
| 事件处理吞吐 | > 100/s | 每秒可处理的事件数 |

### 11.3 用户体验指标

| 指标 | 目标 | 衡量方式 |
|------|------|---------|
| 用户满意度 | > 4.0/5.0 | 用户调研 |
| AI 功能使用率 | > 30% | 使用 AI 辅助的用户比例 |
| 传统模式保持可用 | 100% | 无 AI 时所有功能正常 |

---

## 附录A：术语表

| 术语 | 定义 |
|------|------|
| GOI | Goal-Oriented Interface，目标导向接口，允许声明期望结果而非具体操作步骤 |
| TODO List | 任务列表，AI 规划的执行步骤清单 |
| Checkpoint | 检查点，需要人工确认才能继续执行的节点 |
| Context Compaction | 上下文压缩，将冗长的历史信息摘要为简洁版本 |
| Event Sourcing | 事件溯源，将所有状态变更记录为事件流 |
| Snapshot | 状态快照，某一时刻的完整状态记录，用于回滚 |
| Agent Loop | 代理循环，AI 执行任务的核心循环（Plan-Gather-Act-Verify） |

---

## 附录B：参考资料

1. Claude Code Best Practices - Anthropic Engineering
2. Building Agents with Claude Agent SDK - Anthropic
3. Effective Context Engineering for AI Agents - Anthropic
4. Goal-Oriented Interface (GOI) 论文 - 中科院软件所
5. Context Engineering - LangChain Blog

---

## 附录C：更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-12 | 初版发布 |
